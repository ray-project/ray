name: Build Ray Wheel

triggers:
  push:
    branches: '**'

jobs:
  publish-artlab:
    name: build_ray_wheel
    image: hub.docker.alibaba-inc.com/aidata/ray:build_from_source_accelerated
    runs-on:
      - 32-128Gi
    envs:
      BUILDKITE_COMMIT: ${{git.commitId}}
    traits:
      - type: disable-resources-autoscaling
    steps:
      - uses: checkout
      - id: pull-base-image
        run: echo "pull image"
        container:
          credentials:
            username: ${{secrets.dockerhub_user}}
            password: ${{secrets.dockerhub_password}}
      - uses: setup-bazel
        inputs:
          enable-install-bazelisk: false  # 使用镜像内既有 bazel 版本，改 PATH 会导致 pytest 找不到
          aone-bazel-api-key: ${{secrets.AONE_BAZEL_API_KEY}}
          bazelrc-path: /etc/bazel.bazelrc  # 默认 ~/.bazelrc 已配置，改用系统配置路径
          local-cache-name: ''  # do not mount local cache, image contains external dependencies
      - id: build-ray-wheel
        run: bash python/build-wheel-manylinux2014.sh
      - id: upload-ray-wheel
        uses: upload-oss
        inputs:
          path: .whl/ray-*.whl
          storage-path: omega/etl/package/ray/${{git.commitId}}/
          oss-bucket: bahamutzmf
          oss-endpoint: https://oss-cn-hangzhou-zmf.aliyuncs.com
          access-key-id: ${{secrets.oss_id}}
          access-key-secret: ${{secrets.oss_key}}
