sudo: required

language: generic

matrix:
  include:
  - os: linux
    dist: trusty
    env: PYTHON=3.5 PYTHONWARNINGS=ignore

install:
- ./.travis/install-dependencies.sh
- sudo apt-get install -y gdb
# - sudo apt-get install libtcmalloc-minimal4
- export PATH="$HOME/miniconda/bin:$PATH"
- ./.travis/install-ray.sh
- ./.travis/install-cython-examples.sh

script:
- export PATH="$HOME/miniconda/bin:$PATH"
# The following is needed so cloudpickle can find some of the
# class definitions: The main module of tests that are run
# with pytest have the same name as the test file -- and this
# module is only found if the test directory is in the PYTHONPATH.
- export PYTHONPATH="$PYTHONPATH:./test/"
# - export LD_PRELOAD="/usr/lib/libtcmalloc_minimal.so.4"

- python -m pytest -svvv python/ray/mem_test.py -k test_start_stopw
- python -m pytest -svvv python/ray/mem_test.py -k test_start_stopx
- python -m pytest -svvv python/ray/mem_test.py -k test_start_stop0
- python -m pytest -svvv python/ray/mem_test.py -k test_start_stop1
- python -m pytest -svvv python/ray/mem_test.py -k test_start_stopy
- python -m pytest -svvv python/ray/mem_test.py -k test_start_stopz
# - sudo gdb -ex run --args /home/travis/miniconda/bin/python -m pytest -svvv python/ray/mem_test.py -k test_start_stopw

- python python/ray/mem_test.py
- sudo gdb -ex run -ex bt --args /home/travis/miniconda/bin/python -vvv python/ray/mem_test.py



deploy:
- provider: s3
  access_key_id: AKIAJ2L7XDUSZVTXI5QA
  secret_access_key:
    secure: OS9V8c/fQ9SIOP+Lg2MIz+PtCSKNQVB3mubscDRHKJcCmOp3cB6AKsC/yepbNZvvjDD/ncW2v6KJVsUEneAeDKrZQWSIpNb34yGAvWb7g4xleLxiadNtx6XEzjWaOcg+Y6409e68XeoHq/5ItopWNQ9p9NHXgsoHbZaOurPyHNskNgwBVaObCy+cCak7ifkITDk6cil0OJYnTbOe3NhcU82Fh5BZzS2+G2qNq8tGNcbfINhq0rruWIBuV5WRB/14CmBR+mou74qFSiiodH/MKbOcplx9+BxoOsTnkl7SeyybcK6DX6jxJCuhSBIjct9uT8Qdovv6mzOMkXvLkLKFkHfkTJSGBRIIZEvkPvzhlEriqTcr4tX/MV8HKs/Acz1NnlD0tNEygOr3VaiSLB0dvpz4iCeI9berqSu/jV1VI1X5iVNfChYbOMQ+OYafJMs5WdO60AMWIHy60U511FjAlbS7IubXBjfhoCItIB1xlVNI7FfKaRbNRwP5qvPenB8FUgZpv3UBg5OZDkeBXSNoLydr0w505p6s8Jqnz750TpVYI11fih5D0N3Ea57OwQr9r/rk+Z8aGeTpWj6hIgQiNkrIf2VZnWTApd+utJPw3X3txUEcnOtcdDnMsPuEIeMvIDrrFMRwzClqMNXq9MewU43wp7cCl67YmDBDKubl7Vs=
  bucket: ray-wheels
  acl: public_read
  region: us-west-2
  local_dir: .whl
  upload-dir: $TRAVIS_COMMIT
  skip_cleanup: true
  only:
  - master
  on:
    repo: ray-project/ray
    condition: $LINUX_WHEELS = 1 || $MAC_WHEELS = 1
- provider: s3
  access_key_id: AKIAJ2L7XDUSZVTXI5QA
  secret_access_key:
    secure: OS9V8c/fQ9SIOP+Lg2MIz+PtCSKNQVB3mubscDRHKJcCmOp3cB6AKsC/yepbNZvvjDD/ncW2v6KJVsUEneAeDKrZQWSIpNb34yGAvWb7g4xleLxiadNtx6XEzjWaOcg+Y6409e68XeoHq/5ItopWNQ9p9NHXgsoHbZaOurPyHNskNgwBVaObCy+cCak7ifkITDk6cil0OJYnTbOe3NhcU82Fh5BZzS2+G2qNq8tGNcbfINhq0rruWIBuV5WRB/14CmBR+mou74qFSiiodH/MKbOcplx9+BxoOsTnkl7SeyybcK6DX6jxJCuhSBIjct9uT8Qdovv6mzOMkXvLkLKFkHfkTJSGBRIIZEvkPvzhlEriqTcr4tX/MV8HKs/Acz1NnlD0tNEygOr3VaiSLB0dvpz4iCeI9berqSu/jV1VI1X5iVNfChYbOMQ+OYafJMs5WdO60AMWIHy60U511FjAlbS7IubXBjfhoCItIB1xlVNI7FfKaRbNRwP5qvPenB8FUgZpv3UBg5OZDkeBXSNoLydr0w505p6s8Jqnz750TpVYI11fih5D0N3Ea57OwQr9r/rk+Z8aGeTpWj6hIgQiNkrIf2VZnWTApd+utJPw3X3txUEcnOtcdDnMsPuEIeMvIDrrFMRwzClqMNXq9MewU43wp7cCl67YmDBDKubl7Vs=
  bucket: ray-wheels
  acl: public_read
  region: us-west-2
  local_dir: .whl
  upload-dir: latest
  skip_cleanup: true
  only:
  - master
  on:
    repo: ray-project/ray
    condition: $LINUX_WHEELS = 1 || $MAC_WHEELS = 1
