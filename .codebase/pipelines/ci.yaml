name: Main CI
trigger:
  change:
  manual:
jobs:
  format-check:
    image: hub.byted.org/kuberay/debian_bullseye:ef30b6bdf0ab221c1d3c59f449e887b6
    timeout: 20
    retry: 3
    steps:
      - name: FORMAT_CHECK
        commands:
          - bash .codebase/patch/codebase_format_check.sh
  build-wheels:
    depends: [format-check]
    image: hub.byted.org/kuberay/test.ray.any:230a1f88797dfd9fe36712e0686e4bdc
    steps:
      - name: BUILD_WHEEL
        commands:
          - bash .codebase/patch/codebase_build_wheel.sh
      - name: UPLOAD_WHEEL
        uses: actions/upload-artifact
        inputs:
          name: release
          path: .whl
  core-cpp-ut:
    depends: [format-check]
    image: hub.byted.org/kuberay/test.ray.any:230a1f88797dfd9fe36712e0686e4bdc
    steps:
      - name: CORE_CPP_UT
        commands:
          - bash .codebase/patch/codebase_core_cpp_ut.sh
  python-ut-normal-small:
    depends: [build-wheels]
    image: hub.byted.org/kuberay/debian_bullseye:ef30b6bdf0ab221c1d3c59f449e887b6
    steps:
      - name: DOWNLOAD_WHEEL
        uses: actions/download-artifact
        inputs:
          name: release
          path: ./
      - name: PYTHON_UT
        commands:
          - bash .codebase/patch/codebase_python_ut_normal_small.sh
  python-ut-normal-clientset:
    depends: [build-wheels]
    image: hub.byted.org/kuberay/debian_bullseye:ef30b6bdf0ab221c1d3c59f449e887b6
    steps:
      - name: DOWNLOAD_WHEEL
        uses: actions/download-artifact
        inputs:
          name: release
          path: ./
      - name: PYTHON_UT
        commands:
          - bash .codebase/patch/codebase_python_ut_normal_clientset.sh
  python-ut-serve:
    depends: [build-wheels]
    image: hub.byted.org/kuberay/debian_bullseye:ef30b6bdf0ab221c1d3c59f449e887b6
    steps:
      - name: DOWNLOAD_WHEEL
        uses: actions/download-artifact
        inputs:
          name: release
          path: ./
      - name: PYTHON_UT
        commands:
          - bash .codebase/patch/codebase_python_ut_serve.sh
  # python-ut-dataset:
  #   depends: [build-wheels]
  #   image: hub.byted.org/kuberay/debian_bullseye:ef30b6bdf0ab221c1d3c59f449e887b6
  #   steps:
  #     - name: DOWNLOAD_WHEEL
  #       uses: actions/download-artifact
  #       inputs:
  #         name: release
  #         path: ./
  #     - name: CORE_PYTHON_UT_DATASET
  #       commands:
  #         - bash .codebase/patch/codebase_python_ut_dataset.sh
