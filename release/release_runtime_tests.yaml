###############
# Serve tests
###############

- name: serve_node_draining
  group: Serve tests
  working_dir: anyscale/serve_tests

  frequency: nightly
  team: serve

  cluster:
    byod: {}
    cluster_compute: ../../serve_tests/compute_tpl_8_cpu_autoscaling.yaml

  run:
    timeout: 7200
    long_running: false
    script: python workloads/serve_node_draining.py

  alert: default

  variations:
    - __suffix__: aws
    - __suffix__: gce
      env: gce
      frequency: manual
      cluster:
        cluster_compute: ../../serve_tests/compute_tpl_8_cpu_autoscaling_gce.yaml

###############
# Data tests
###############

- name: video_batch_inference_benchmark
  group: data-tests
  working_dir: anyscale/data

  frequency: nightly
  stable: False
  team: data
  cluster:
    byod:
      type: gpu
    cluster_compute: video_batch_inference_benchmark_compute.yaml

  run:
    timeout: 3600
    script: python video_batch_inference_benchmark.py

  variations:
    - __suffix__: aws

- name: audio_batch_inference_benchmark
  group: data-tests
  working_dir: anyscale/data

  frequency: nightly
  team: data
  cluster:
    byod:
      type: gpu
      post_build_script: byod_install_soundfile.sh
    cluster_compute: audio_batch_inference_benchmark_compute.yaml

  run:
    timeout: 1800
    script: python audio_batch_inference_benchmark.py

  variations:
    - __suffix__: aws

- name: cpu_job_autoscaling_benchmark
  group: data-tests
  working_dir: anyscale/data

  frequency: nightly
  team: data
  cluster:
    byod:
      type: gpu
    cluster_compute: cpu_job_autoscaling_benchmark_compute.yaml

  run:
    timeout: 3600
    script: python cpu_job_autoscaling_benchmark.py

  variations:
    - __suffix__: aws

- name: batch_inference_job_autoscaling_benchmark
  group: data-tests
  working_dir: anyscale/data

  frequency: nightly
  team: data
  cluster:
    byod:
      type: gpu
    cluster_compute: batch_inference_job_autoscaling_benchmark_compute.yaml

  run:
    timeout: 3600
    script: python video_batch_inference_benchmark.py --min-gpus 1 --max-gpus 32

  variations:
    - __suffix__: aws

###############
# Rllib tests
###############

- name: rllib_multi_node_e2e_training_test
  group: RLlib tests
  working_dir: rllib_tests

  frequency: nightly
  team: rllib
  cluster:
    byod:
      type: gpu
      post_build_script: byod_rllib_test.sh
      runtime_env:
        - RLLIB_TEST_NO_JAX_IMPORT=1
        - LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/ray/.mujoco/mujoco210/bin
    cluster_compute: multi_node_ckpt_training_compute_config.yaml

  run:
    timeout: 3600
    script: pytest multinode_training_checkpointing_tests/smoke_test_basic_multi_node_training_learner.py

    wait_for_nodes:
      num_nodes: 2

  alert: default

  variations:
    - __suffix__: aws
    - __suffix__: gce
      env: gce
      frequency: manual
      cluster:
        cluster_compute: multi_node_ckpt_training_compute_config_gce.yaml

###############
# Train tests
###############
- name: train_elastic_e2e_with_node_killing
  group: Train tests
  working_dir: anyscale/train/elastic_e2e

  frequency: weekly
  team: ml

  cluster:
    byod:
      type: gpu
    cluster_compute: compute_gpu_aws.yaml

  run:
    timeout: 4800
    script: RAY_TRAIN_V2_ENABLED=1 python torch_elastic_e2e.py run --num-epochs 60

    wait_for_nodes:
      num_nodes: 1

  variations:
    - __suffix__: aws

  alert: default
