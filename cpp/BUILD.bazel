# Bazel build
# C/C++ documentation: https://docs.bazel.build/versions/master/be/c-cpp.html

load("//bazel:ray.bzl", "COPTS")

cc_library(
    name = "libray_api_hdr",
    copts = COPTS,
    hdrs = glob([
        "include/ray/*.h",
        "include/ray/**/*.h",
        "include/ray/**/**/*.h",
    ]),
    strip_include_prefix = "include",
    deps = [
        "@plasma//:plasma_client",
        "@msgpack//:msgpack",
        "//:ray_common",
        "//:core_worker_lib",
    ],
)

cc_binary(
    name = "libray_api.so",
    copts = COPTS,
    srcs = glob([
        "src/ray/api.cc",
        "src/ray/api/*.cc",
        "src/ray/api/*.h",
        "src/ray/app/*.cc",
        "src/ray/app/*.h",
        "src/ray/runtime/*.cc",
        "src/ray/runtime/*.h",
        "src/ray/runtime/**/*.cc",
        "src/ray/runtime/**/*.h",
        "src/ray/runtime/task/*.cc",
        "src/ray/runtime/task/*.h",
        "src/ray/util/*.cc",
        "src/ray/util/*.h",
        "src/ray/*.cc",
        "src/ray/*.h",
    ]),
    deps = [
        "libray_api_hdr",
        "@boost//:asio",
        "@boost//:thread",
        "@msgpack//:msgpack",
        "//:ray_common",
        "//:core_worker_lib",
    ],
    linkshared = 1,
    linkstatic = 1,
)

cc_import(
    name = "ray_api",
    shared_library = "libray_api.so",
)

cc_binary(
    name = "example",
    copts = COPTS,
    testonly = 1,
    srcs = [
        "src/example/example.cc",
        "src/example/example.h"
        ],
    deps = [
        "ray_api",
        "libray_api_hdr",
    ],
)

cc_binary(
    name = "api_test",
    copts = COPTS,
    testonly = 1,
    srcs = [
        "src/ray/test/api_test.cc"
        ],
    deps = [
        "ray_api",
        "libray_api_hdr",
        "@com_google_googletest//:gtest_main"
    ],
)

cc_binary(
    name = "wrap_test",
    copts = COPTS,
    testonly = 1,
    srcs = [
        "src/ray/test/wrap_test.cc"
        ],
    deps = [
        "ray_api",
        "libray_api_hdr",
        "@com_google_googletest//:gtest_main"
    ],
)

cc_binary(
    name = "slow_function_test",
    copts = COPTS,
    testonly = 1,
    srcs = [
        "src/ray/test/slow_function_test.cc"
        ],
    deps = [
        "ray_api",
        "libray_api_hdr",
        "@com_google_googletest//:gtest_main"
    ],
)