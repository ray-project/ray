# A unique identifier for the head node and workers of this cluster.
cluster_name: tputest

# The maximum number of worker nodes to launch in addition to the head
# node. min_workers default to 0.
max_workers: 1

available_node_types:
    ray_head_default:
        min_workers: 0
        max_workers: 0
        resources: {"CPU": 2}
        node_config:
            machineType: n1-standard-2
            disks:
              - boot: true
                autoDelete: true
                type: PERSISTENT
                initializeParams:
                  diskSizeGb: 50
                  # See https://cloud.google.com/compute/docs/images for more images
                  sourceImage: projects/deeplearning-platform-release/global/images/family/common-cpu
    ray_tpu:
        min_workers: 1
        resources: {"TPU": 1}
        node_config:
            acceleratorType: v2-8
            runtimeVersion: v2-alpha
            schedulingConfig:
                preemptible: True

provider:
    type: gcp
    region: us-central1
    availability_zone: us-central1-f
    project_id: tpu-test-320314

setup_commands: []


# Compute instances have python 3.7, but TPUs have 3.8 - need to update
head_setup_commands:
  - sleep 2 && sudo apt-get install -y build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libsqlite3-dev libreadline-dev libffi-dev curl libbz2-dev && curl -O https://www.python.org/ftp/python/3.8.5/Python-3.8.5.tar.xz && tar -xf Python-3.8.5.tar.xz && cd Python-3.8.5 && ./configure && make -j 4 && sudo make install
  - python3.8 -m pip install -U https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-2.0.0.dev0-cp38-cp38-manylinux2014_x86_64.whl && wget https://raw.githubusercontent.com/Yard1/ray/gcp_tpu_autoscaler/python/ray/autoscaler/_private/gcp/config.py && wget https://raw.githubusercontent.com/Yard1/ray/gcp_tpu_autoscaler/python/ray/autoscaler/_private/gcp/node.py && wget https://raw.githubusercontent.com/Yard1/ray/gcp_tpu_autoscaler/python/ray/autoscaler/_private/gcp/node_provider.py && cp -f config.py ~/.local/lib/python3.8/site-packages/ray/autoscaler/_private/gcp/ && cp -f node.py ~/.local/lib/python3.8/site-packages/ray/autoscaler/_private/gcp/ && cp -f node_provider.py ~/.local/lib/python3.8/site-packages/ray/autoscaler/_private/gcp/
  - python3.8 -m pip install google-api-python-client==1.7.8 cryptography

worker_setup_commands:
  - pip3 install -U https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-2.0.0.dev0-cp38-cp38-manylinux2014_x86_64.whl
  - pip3 install google-api-python-client==1.7.8
