rules:
  - id: code-block-python
    paths:
      include:
        # Ray Core
        - "python/ray/util/**/*.py"
        - "python/ray/_private/**/*.py"
        - "python/ray/core/**/*.py"
        - "doc/source/ray-core/**/*.rst"
        - "doc/source/ray-overview/**/*.rst"
        - "doc/source/ray-observability/**/*.rst"
        # Ray Data
        - "python/ray/data/**/*.py"
        - "doc/source/data/**/*.rst"
        # Ray Train
        - "python/ray/train/**/*.py"
        - "doc/source/train/**/*.rst"
      exclude:
        # These files use the :emphasize-lines: option, which isn't supported by testcode.
        - "doc/source/train/getting-started-pytorch-lightning.rst"
        - "doc/source/train/getting-started-pytorch.rst"
        - "doc/source/train/getting-started-transformers.rst"
        - "doc/source/train/user-guides/data-loading-preprocessing.rst"

    languages:
      - generic
    message: "Don't use 'code-block:: python', it's not tested! Use 'testcode' instead! For more information, see https://docs.ray.io/en/master/ray-contribute/writing-code-snippets.html."
    pattern: "code-block:: python"
    severity: ERROR

  - id: missing-pytest-main
    paths:
      include:
        - "python/ray/data/tests/**/test_*.py"
      exclude:
        # FIXME: These tests weren't run in CI, and now they're failing.
        - "python/ray/data/tests/test_arrow_serialization.py"
        - "python/ray/data/tests/test_block.py"
        - "python/ray/data/tests/test_expression_evaluator.py"
        - "python/ray/data/tests/test_hash_shuffle.py"
    languages:
      - python
    message: |
      Add the following snippet to the end of the file so that the tests run
      in CI.

      if __name__ == "__main__":
          import sys

          import pytest

          sys.exit(pytest.main(["-v", __file__]))
    patterns:
      - pattern-regex: |
          (?s)(.*)
      - pattern-not-regex: pytest.main
    severity: ERROR
