load("//bazel:ray.bzl", "ray_cc_library")

ray_cc_library(
    name = "compat",
    hdrs = ["compat.h"],
)

ray_cc_library(
    name = "constants",
    hdrs = ["constants.h"],
)

ray_cc_library(
    name = "test_util",
    srcs = ["test_util.cc"],
    hdrs = ["test_util.h"],
    deps = [
        ":asio",
        ":id",
        ":ray_object",
        "//src/ray/protobuf:common_cc_proto",
        "//src/ray/util:cmd_line_utils",
        "//src/ray/util:network_util",
        "//src/ray/util:path_utils",
        "//src/ray/util:process",
        "//src/ray/util:time",
        "@boost//:optional",
        "@com_google_googletest//:gtest",
    ],
)

ray_cc_library(
    name = "buffer",
    hdrs = ["buffer.h"],
    deps = [
        ":status",
        "//src/ray/thirdparty:aligned_alloc",
        "//src/ray/util:logging",
    ],
)

ray_cc_library(
    name = "ray_object",
    srcs = ["ray_object.cc"],
    hdrs = [
        "ray_object.h",
    ],
    deps = [
        ":buffer",
        ":id",
        "//src/ray/protobuf:gcs_cc_proto",
        "//src/ray/util:logging",
        "@com_google_absl//absl/time",
        "@com_google_absl//absl/types:optional",
        "@msgpack",
    ],
)

ray_cc_library(
    name = "grpc_util",
    hdrs = ["grpc_util.h"],
    deps = [
        ":ray_config",
        ":status",
        "//src/ray/util:logging",
        "//src/ray/util:type_traits",
        "@com_github_grpc_grpc//:grpc++",
        "@com_google_absl//absl/container:flat_hash_map",
    ],
)

ray_cc_library(
    name = "memory_monitor",
    srcs = [
        "memory_monitor.cc",
    ],
    hdrs = [
        "memory_monitor.h",
    ],
    deps = [
        ":asio",
        ":ray_config",
        "//src/ray/util:process",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:str_format",
        "@com_google_googletest//:gtest_prod",
        "@nlohmann_json",
    ],
)

ray_cc_library(
    name = "file_system_monitor",
    srcs = ["file_system_monitor.cc"],
    hdrs = ["file_system_monitor.h"],
    deps = [
        ":asio",
        "//src/ray/util:event",
        "@com_google_googletest//:gtest_prod",
    ],
)

ray_cc_library(
    name = "runtime_env",
    srcs = [
        "runtime_env_common.cc",
        "runtime_env_manager.cc",
    ],
    hdrs = [
        "runtime_env_common.h",
        "runtime_env_manager.h",
    ],
    deps = [
        ":id",
        "//src/ray/protobuf:common_cc_proto",
        "@com_google_absl//absl/container:flat_hash_map",
    ],
)

ray_cc_library(
    name = "id",
    srcs = [
        "common_protocol.cc",
        "id.cc",
    ],
    hdrs = [
        "common_protocol.h",
        "id.h",
        "id_def.h",
    ],
    deps = [
        ":constants",
        ":status",
        "//src/ray/protobuf:common_cc_proto",
        "//src/ray/protobuf:gcs_cc_proto",
        "//src/ray/thirdparty:sha256",
        "//src/ray/util:random",
        "@com_github_google_flatbuffers//:flatbuffers",
        "@msgpack",
    ],
)

ray_cc_library(
    name = "scheduling_ids",
    srcs = ["scheduling/scheduling_ids.cc"],
    hdrs = ["scheduling/scheduling_ids.h"],
    deps = [
        ":constants",
        ":ray_config",
        "//src/ray/util:logging",
        "@boost//:algorithm",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/synchronization",
    ],
)

ray_cc_library(
    name = "label_selector",
    srcs = ["scheduling/label_selector.cc"],
    hdrs = ["scheduling/label_selector.h"],
    deps = [
        "//src/ray/protobuf:common_cc_proto",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/strings",
        "@com_google_protobuf//:protobuf",
    ],
)

ray_cc_library(
    name = "fixed_point",
    srcs = ["scheduling/fixed_point.cc"],
    hdrs = ["scheduling/fixed_point.h"],
    deps = [
        ":constants",
    ],
)

ray_cc_library(
    name = "placement_group_util",
    srcs = ["scheduling/placement_group_util.cc"],
    hdrs = ["scheduling/placement_group_util.h"],
    deps = [
        ":scheduling_ids",
        "//src/ray/util:logging",
    ],
)

ray_cc_library(
    name = "resource_set",
    srcs = ["scheduling/resource_set.cc"],
    hdrs = ["scheduling/resource_set.h"],
    deps = [
        ":fixed_point",
        ":scheduling_ids",
        "@boost//:range",
        "@com_google_absl//absl/container:flat_hash_map",
    ],
)

ray_cc_library(
    name = "cluster_resource_data",
    srcs = ["scheduling/cluster_resource_data.cc"],
    hdrs = ["scheduling/cluster_resource_data.h"],
    deps = [
        ":fixed_point",
        ":label_selector",
        ":resource_instance_set",
        ":resource_set",
        ":scheduling_ids",
        "//src/ray/util:logging",
        "@boost//:range",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/time",
    ],
)

ray_cc_library(
    name = "bundle_spec",
    srcs = [
        "bundle_spec.cc",
    ],
    hdrs = [
        "bundle_spec.h",
    ],
    deps = [
        ":cluster_resource_data",
        ":grpc_util",
        ":id",
        ":label_selector",
        ":placement_group_util",
        ":scheduling_ids",
        "//src/ray/protobuf:common_cc_proto",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_protobuf//:protobuf",
    ],
)

ray_cc_library(
    name = "placement_group",
    srcs = [
        "placement_group.cc",
    ],
    hdrs = [
        "placement_group.h",
    ],
    deps = [
        ":bundle_spec",
        ":id",
        "//src/ray/protobuf:common_cc_proto",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_protobuf//:protobuf",
    ],
)

ray_cc_library(
    name = "function_descriptor",
    srcs = ["function_descriptor.cc"],
    hdrs = ["function_descriptor.h"],
    deps = [
        ":grpc_util",
        "//src/ray/protobuf:common_cc_proto",
        "//src/ray/util:logging",
        "@com_google_absl//absl/strings:str_format",
    ],
)

ray_cc_library(
    name = "scheduling_class_util",
    srcs = ["scheduling/scheduling_class_util.cc"],
    hdrs = ["scheduling/scheduling_class_util.h"],
    deps = [
        ":function_descriptor",
        ":label_selector",
        ":resource_set",
        ":runtime_env",
        "//src/ray/protobuf:common_cc_proto",
        "//src/ray/util:logging",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/synchronization",
        "@com_google_protobuf//:protobuf",
    ],
)

ray_cc_library(
    name = "resource_instance_set",
    srcs = ["scheduling/resource_instance_set.cc"],
    hdrs = ["scheduling/resource_instance_set.h"],
    deps = [
        ":fixed_point",
        ":placement_group_util",
        ":resource_set",
        ":scheduling_ids",
        "//src/ray/util:container_util",
        "//src/ray/util:logging",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/strings",
    ],
)

ray_cc_library(
    name = "bundle_location_index",
    srcs = ["bundle_location_index.cc"],
    hdrs = ["bundle_location_index.h"],
    deps = [
        ":id",
        ":placement_group",
        "//src/ray/protobuf:gcs_cc_proto",
        "@com_google_absl//absl/container:flat_hash_map",
    ],
)

ray_cc_library(
    name = "task_common",
    srcs = [
        "task/task_spec.cc",
    ],
    hdrs = [
        "task/task_common.h",
        "task/task_spec.h",
        "task/task_util.h",
    ],
    deps = [
        ":event_stats",
        ":function_descriptor",
        ":grpc_util",
        ":label_selector",
        ":ray_config",
        ":ray_object",
        ":resource_set",
        ":runtime_env",
        ":scheduling_class_util",
        "//src/ray/flatbuffers:node_manager_generated",
        "//src/ray/util:container_util",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:str_format",
    ],
)

ray_cc_library(
    name = "lease",
    srcs = [
        "lease/lease_spec.cc",
    ],
    hdrs = [
        "lease/lease.h",
        "lease/lease_spec.h",
    ],
    deps = [
        ":function_descriptor",
        ":id",
        ":label_selector",
        ":resource_set",
        ":runtime_env",
        ":scheduling_class_util",
        "//src/ray/protobuf:common_cc_proto",
    ],
)

ray_cc_library(
    name = "asio",
    srcs = [
        "asio/asio_chaos.cc",
        "asio/instrumented_io_context.cc",
        "asio/io_service_pool.cc",
        "asio/periodical_runner.cc",
    ],
    hdrs = [
        "asio/asio_chaos.h",
        "asio/asio_util.h",
        "asio/instrumented_io_context.h",
        "asio/io_service_pool.h",
        "asio/periodical_runner.h",
        "asio/postable.h",
    ],
    deps = [
        ":event_stats",
        ":ray_config",
        "//src/ray/util:array",
        "//src/ray/util:function_traits",
        "@boost//:asio",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/synchronization",
    ],
)

ray_cc_library(
    name = "event_stats",
    srcs = [
        "event_stats.cc",
    ],
    hdrs = [
        "event_stats.h",
    ],
    deps = [
        ":ray_config",
        "//src/ray/stats:stats_metric",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/synchronization",
    ],
)

ray_cc_library(
    name = "ray_config",
    srcs = ["ray_config.cc"],
    hdrs = [
        "ray_config.h",
        "ray_config_def.h",
        "ray_internal_flag_def.h",
    ],
    deps = [
        "//src/ray/util:logging",
        "@boost//:algorithm",
        "@com_google_absl//absl/strings",
        "@nlohmann_json",
    ],
)

ray_cc_library(
    name = "ray_syncer",
    srcs = [
        "ray_syncer/node_state.cc",
        "ray_syncer/ray_syncer.cc",
        "ray_syncer/ray_syncer_client.cc",
        "ray_syncer/ray_syncer_server.cc",
    ],
    hdrs = [
        "ray_syncer/common.h",
        "ray_syncer/node_state.h",
        "ray_syncer/ray_syncer.h",
        "ray_syncer/ray_syncer_bidi_reactor.h",
        "ray_syncer/ray_syncer_bidi_reactor_base.h",
        "ray_syncer/ray_syncer_client.h",
        "ray_syncer/ray_syncer_server.h",
    ],
    deps = [
        ":asio",
        ":id",
        "//:ray_syncer_cc_grpc",
        "@com_github_grpc_grpc//:grpc++",
        "@com_google_absl//absl/container:flat_hash_map",
    ],
)

ray_cc_library(
    name = "status",
    srcs = ["status.cc"],
    hdrs = ["status.h"],
    deps = [
        ":macros",
        ":source_location",
        "//src/ray/util:logging",
        "//src/ray/util:macros",
        "//src/ray/util:visibility",
        "@boost//:system",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/strings",
    ],
)

ray_cc_library(
    name = "macros",
    hdrs = ["macros.h"],
)

ray_cc_library(
    name = "status_or",
    hdrs = ["status_or.h"],
    deps = [
        ":macros",
        ":status",
        "//src/ray/util:logging",
        "@com_google_absl//absl/base:core_headers",
    ],
)

ray_cc_library(
    name = "source_location",
    srcs = ["source_location.cc"],
    hdrs = ["source_location.h"],
)
