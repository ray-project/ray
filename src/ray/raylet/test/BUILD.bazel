load("//bazel:ray.bzl", "ray_cc_library", "ray_cc_test")

ray_cc_library(
    name = "util",
    hdrs = ["util.h"],
    # NOTE(edoakes): scheduling/ tests use this; the dependency should be broken.
    visibility = ["//visibility:public"],
    deps = [
        "//src/ray/raylet:worker",
    ],
)

ray_cc_test(
    name = "wait_manager_test",
    size = "small",
    srcs = ["wait_manager_test.cc"],
    tags = ["team:core"],
    deps = [
        "//src/ray/raylet:wait_manager",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "worker_pool_test",
    size = "small",
    srcs = ["worker_pool_test.cc"],
    tags = [
        "no_tsan",
        "team:core",
    ],
    deps = [
        "//:ray_mock",
        "//src/ray/raylet:worker_pool",
        "//src/ray/util:path_utils",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "local_object_manager_test",
    size = "small",
    srcs = [
        "local_object_manager_test.cc",
    ],
    tags = ["team:core"],
    deps = [
        ":util",
        "//:ray_mock",
        "//src/ray/common:asio",
        "//src/ray/common:id",
        "//src/ray/gcs/gcs_client:gcs_client_lib",
        "//src/ray/object_manager:ownership_object_directory",
        "//src/ray/protobuf:core_worker_cc_grpc",
        "//src/ray/pubsub:subscriber",
        "//src/ray/raylet:local_object_manager",
        "//src/ray/raylet:worker_pool",
        "//src/ray/rpc:core_worker_client",
        "//src/ray/rpc:grpc_client",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "placement_group_resource_manager_test",
    size = "small",
    srcs = ["placement_group_resource_manager_test.cc"],
    tags = ["team:core"],
    deps = [
        "//:ray_mock",
        "//src/ray/common:id",
        "//src/ray/common:task_common",
        "//src/ray/gcs/test:gcs_test_util_lib",
        "//src/ray/raylet:placement_group_resource_manager",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "runtime_env_agent_client_test",
    size = "small",
    srcs = ["runtime_env_agent_client_test.cc"],
    tags = ["team:core"],
    deps = [
        "//:ray_mock",
        "//src/ray/common:asio",
        "//src/ray/common:id",
        "//src/ray/protobuf:runtime_env_agent_cc_proto",
        "//src/ray/raylet:runtime_env_agent_client",
        "@boost//:asio",
        "@boost//:beast",
        "@boost//:thread",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "dependency_manager_test",
    size = "small",
    srcs = ["dependency_manager_test.cc"],
    tags = ["team:core"],
    deps = [
        "//:ray_mock",
        "//src/ray/common:task_common",
        "//src/ray/common:test_util",
        "//src/ray/raylet:dependency_manager",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "local_task_manager_test",
    size = "small",
    srcs = ["local_task_manager_test.cc"],
    tags = ["team:core"],
    deps = [
        ":util",
        "//:ray_mock",
        "//src/ray/common:id",
        "//src/ray/common:task_common",
        "//src/ray/common:test_util",
        "//src/ray/raylet:local_task_manager",
        "//src/ray/raylet/scheduling:cluster_resource_scheduler",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "worker_killing_policy_test",
    size = "small",
    srcs = [
        "worker_killing_policy_test.cc",
    ],
    tags = ["team:core"],
    deps = [
        ":util",
        "//src/ray/common:task_common",
        "//src/ray/raylet:worker_killing_policy",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "worker_killing_policy_group_by_owner_test",
    size = "small",
    srcs = [
        "worker_killing_policy_group_by_owner_test.cc",
    ],
    tags = ["team:core"],
    deps = [
        ":util",
        "//src/ray/common:task_common",
        "//src/ray/raylet:worker_killing_policy",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "worker_killing_policy_retriable_fifo_test",
    size = "small",
    srcs = [
        "worker_killing_policy_retriable_fifo_test.cc",
    ],
    tags = ["team:core"],
    deps = [
        ":util",
        "//src/ray/common:task_common",
        "//src/ray/raylet:worker_killing_policy",
        "@com_google_googletest//:gtest_main",
    ],
)

ray_cc_test(
    name = "node_manager_test",
    size = "small",
    srcs = ["node_manager_test.cc"],
    tags = ["team:core"],
    deps = [
        ":util",
        "//:ray_fakes",
        "//:ray_mock",
        "//src/ray/common:ray_object",
        "//src/ray/object_manager/plasma:plasma_client",
        "//src/ray/raylet:local_object_manager_interface",
        "//src/ray/raylet:node_manager",
        "//src/ray/raylet/scheduling:cluster_task_manager",
        "//src/ray/util:macros",
        "@com_google_googletest//:gtest_main",
    ],
)
