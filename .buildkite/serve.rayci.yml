group: serve tests
depends_on:
  - forge
  - oss-ci-base_build
steps:
  # builds
  - name: servebuild
    wanda: ci/docker/serve.build.py39.wanda.yaml

  - name: servebuild-multipy
    label: "wanda: servebuild-py{{matrix}}"
    wanda: ci/docker/serve.build.wanda.yaml
    matrix: ["3.11"]
    env:
      PYTHON: "{{matrix}}"
    depends_on: oss-ci-base_build-multipy

  - name: servepydantic1build
    wanda: ci/docker/servepydantic1.build.wanda.yaml

  - name: minbuild-serve
    label: "wanda: minbuild-{{matrix}}-py39"
    wanda: ci/docker/min.build.wanda.yaml
    matrix:
      - serve
      - default
    env:
      PYTHON_VERSION: "3.9"
      EXTRA_DEPENDENCY: "{{matrix}}"

  # tests
  - label: ":ray-serve: serve: serve minimal"
    tags:
      - serve
      - python
    instance_type: small
    commands:
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/serve/tests/... serve 
        --parallelism-per-worker 2
        --build-name minbuild-serve-py3.9
        --test-env=RAY_DEFAULT=1
        --only-tags minimal
    depends_on: minbuild-serve

  - label: ":ray-serve: serve: dashboard tests"
    tags: 
      - serve
      - python
      - dashboard
    instance_type: medium
    commands:
      - bazel run //ci/ray_ci:test_in_docker -- python/ray/dashboard/... serve 
        --parallelism-per-worker 3
      - sleep 18000
    depends_on: servebuild

