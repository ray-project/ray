group: windows tests
sort_key: "~windows"
steps:
  # block on premerge and microcheck
  - block: "run windows tests"
    if: build.env("BUILDKITE_PIPELINE_ID") == "0189942e-0876-4b8f-80a4-617f988ec59b" || build.env("BUILDKITE_PIPELINE_ID") == "018f4f1e-1b73-4906-9802-92422e3badaa"

  - name: windowsbuild
    wanda: ci/docker/windows.build.wanda.yaml
    instance_type: builder-windows

  - label: ":windows: wheel {{matrix}}"
    # we have linux/mac wheels tag, but do not have a windows wheels tag..
    # so using python and core_cpp here, to make sure at least it builds
    key: windows_wheels
    tags:
      - oss
      - python
      - core_cpp
    job_env: WINDOWS
    instance_type: windows
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:build_in_docker_windows -- wheel --python-version {{matrix}} --operating-system windows --upload
    matrix:
      - "3.9"
      - "3.10"
      - "3.11"
      - "3.12"
    depends_on: windowsbuild

  - label: ":ray: core: :windows: cpp tests"
    tags: core_cpp
    job_env: WINDOWS
    instance_type: windows
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //:all //src/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows,cgroup
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --parallelism-per-worker 2
    depends_on: windowsbuild

  - label: ":ray: core: :windows: python tests 1"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 2"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 3"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 4"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 5"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 6"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 7"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 8"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 9"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 10"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 11"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 12"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 13"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 14"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 15"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 16"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 17"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 18"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 19"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
  - label: ":ray: core: :windows: python tests 20"
    tags: python
    job_env: WINDOWS
    instance_type: windows
    parallelism: 5
    commands:
      - bash ci/ray_ci/windows/install_tools.sh
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core
        --build-name windowsbuild
        --operating-system windows
        --except-tags no_windows
        --test-env=CI="1"
        --test-env=RAY_CI_POST_WHEEL_TESTS="1"
        --test-env=USERPROFILE
        --workers "$${BUILDKITE_PARALLEL_JOB_COUNT}" --worker-id "$${BUILDKITE_PARALLEL_JOB}" --parallelism-per-worker 2
    depends_on: windowsbuild
