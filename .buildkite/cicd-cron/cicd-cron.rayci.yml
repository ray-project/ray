group: cicd-cron
steps:
  - name: manylinux-cibase-{{matrix}}
    label: ":magic_wand: wanda: manylinux-cibase-{{matrix}}"
    wanda: ci/docker/manylinux-cibase.wanda.yaml
    matrix:
      - "x86_64"
      - "aarch64"
    instance_type: builder-{{matrix}}
    env:
      RAYCI_DISABLE_JAVA: "true"
      RAYCI_WANDA_ALWAYS_REBUILD: "true"
      JDK_SUFFIX: ""
      ARCH_SUFFIX: ""
      HOSTTYPE: "{{matrix}}"

  - name: manylinux-cibase-jdk-{{matrix}}
    label: ":magic_wand: wanda: manylinux-cibase-jdk-{{matrix}}"
    wanda: ci/docker/manylinux-cibase.wanda.yaml
    matrix:
      - "x86_64"
      - "aarch64"
    env:
      RAYCI_DISABLE_JAVA: "false"
      RAYCI_WANDA_ALWAYS_REBUILD: "true"
      JDK_SUFFIX: "-jdk"
      ARCH_SUFFIX: ""
      HOSTTYPE: "{{matrix}}"

  - label: ":docker: push: Push manylinux-cibase-{{matrix}} to Docker Hub"
    depends_on:
      - manylinux-cibase-{{matrix}}
      - forge
    job_env: forge
    matrix:
      - "x86_64"
      - "aarch64"
    commands:
      - bazel run //.buildkite:copy_files -- --destination docker_login
      - bazel run //ci/ray_ci/automation:copy_wanda_image --
        --wanda-image-name manylinux-cibase
        --destination-repository rayproject/manylinux2014
        --tag-suffix -{{matrix}}

  - label: ":docker: push: Push manylinux-cibase-jdk to Docker Hub"
    depends_on:
      - manylinux-cibase-jdk-{{matrix}}
      - forge
    job_env: forge
    matrix:
      - "x86_64"
      - "aarch64"
    commands:
      - bazel run //.buildkite:copy_files -- --destination docker_login
      - bazel run //ci/ray_ci/automation:copy_wanda_image --
        --wanda-image-name manylinux-cibase-jdk
        --destination-repository rayproject/manylinux2014
        --tag-suffix -jdk-{{matrix}}
