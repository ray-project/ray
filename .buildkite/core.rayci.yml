group: core tests
depends_on:
  - forge
  - oss-ci-base_build
steps:
  # builds
  - name: corebuild
    wanda: ci/docker/core.build.py39.wanda.yaml

  - name: corebuild-multipy
    label: "wanda: corebuild-py{{matrix}}"
    wanda: ci/docker/core.build.wanda.yaml
    matrix:
      - "3.10"
    env:
      PYTHON: "{{matrix}}"
    depends_on: oss-ci-base_build-multipy

  - name: minbuild-core
    label: "wanda: minbuild-core-py{{matrix}}"
    wanda: ci/docker/min.build.wanda.yaml
    matrix:
      - "3.9"
      - "3.10"
      - "3.11"
    env:
      PYTHON_VERSION: "{{matrix}}"
      EXTRA_DEPENDENCY: core

  - wait: ~
    depends_on:
      - corebuild

  - label: ":ray: core: container tests"
    tags:
      - python
      - docker
    instance_type: medium
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- docker --platform cpu
        --canonical-tag test_container
      - docker build --progress=plain --build-arg BASE_IMAGE="rayproject/ray:test_container"
        -t rayproject/ray:runtime_env_container -f docker/runtime_env_container/Dockerfile .
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... core --only-tags container
    depends_on:
      - manylinux
      - forge
      - raycpubase
      - corebuild
