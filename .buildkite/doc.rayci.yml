group: doc
steps:
  - name: docbuild
    label: "wanda: docbuild-py{{matrix}}"
    wanda: ci/docker/doc.build.wanda.yaml
    depends_on:
      - oss-ci-base_build-multipy
      - ray-core-build
      - ray-dashboard-build
    matrix:
      - "3.9"
      - "3.10"
      - "3.12"
    env:
      PYTHON: "{{matrix}}"
      REQUIREMENTS_FILE: "python/deplocks/docs/docbuild_depset_py{{matrix}}.lock"
    tags: cibase

  - name: docgpubuild
    label: "wanda: docgpubuild-py3.10"
    wanda: ci/docker/docgpu.build.wanda.yaml
    depends_on: oss-ci-base_gpu-multipy
    env:
      PYTHON: "3.10"
    tags: cibase

  - label: ":book: doc: build"
    key: doc_build
    instance_type: medium
    commands:
      - bazel run //ci/ray_ci/doc:cmd_build
    depends_on: docbuild
    job_env: docbuild-py3.10
    tags:
      - oss
      - doc
      - skip-on-premerge

  - label: ":book: doc: check API annotations"
    tags:
      - oss
      - python
      - dashboard
      - ray_client
      - data
      - serve
      - ml
      - tune
      - train
      - llm
      - rllib
      - rllib_gpu
      - doc
    key: doc_api_annotations
    instance_type: medium
    depends_on: docbuild
    job_env: docbuild-py3.10
    commands:
      - bash ci/lint/lint.sh api_annotations

  - label: ":book: doc: check API doc consistency"
    tags:
      - oss
      - python
      - dashboard
      - ray_client
      - data
      - serve
      - ml
      - tune
      - train
      - llm
      - rllib
      - rllib_gpu
      - doc
    key: doc_api_policy_check
    instance_type: medium
    depends_on: docbuild
    # TODO(aslonnie): migrate to Python 3.12
    job_env: docbuild-py3.9
    commands:
      - bash ci/lint/lint.sh api_policy_check

  - label: ":book: doc: linkcheck"
    key: doc_linkcheck
    instance_type: medium
    commands:
      - make -C doc/ linkcheck_all
    depends_on: docbuild
    job_env: docbuild-py3.10
    tags:
      - oss
      - skip-on-premerge
    soft_fail: true
