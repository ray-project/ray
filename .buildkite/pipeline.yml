steps:
  - label: "Setting up build env"
    commands:
      - docker build -f .buildkite/Dockerfile -t 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env .
      # ECR login should be done by Elastic CI stack runners for us
      - docker push 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env
    agents:
      queue: simon-agent-q
  - wait
  - label: "Run inside build env"
    commands:
      - ./ci/travis/ci.sh init
      - ./ci/travis/ci.sh build
      - ./ci/suppress_output bazel test --config=ci $(./scripts/bazel_export_options) --build_tests_only -- //:all -rllib/...
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env
          debug: true
          user: root
          shell: ["/bin/bash", "-e", "-c"]
          shm-size: 2g
          propagate-environment: true
    env:
      PYTHON: "3.6"
      CI: "true"
      SMALL_AND_LARGE_TESTS: "1"
      RAY_DEFAULT_BUILD: "1"
      RAY_USE_RANDOM_PORTS: "1"
    agents:
      queue: simon-agent-q
