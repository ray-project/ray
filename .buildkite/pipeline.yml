steps:
  - label: "Setting up bootstrap env"
    commands:
      - mv /tmp/bazel-credential.json .
      - aws ecr get-login-password --region us-west-2 > ecr_password.txt
      - docker build -f .buildkite/Dockerfile -t 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env:$BUILDKITE_COMMIT .
      - docker push 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env:$BUILDKITE_COMMIT
    agents:
      queue: simon-agent-q
  - wait
  - label: "Build shared container"
    commands:
      - cat /root/.bazelrc
      # Copy the git checkout to local directory so it will be captured by docker commit
      - cp -r /mounted_workdir /workdir
      - cd /workdir
      # Run legacy environment setup
      - ./ci/travis/ci.sh init
      - ./ci/travis/ci.sh build
      - cat /root/.bazelrc
      # Commit this container
      - /bin/docker tag $(docker commit --pause=false $(hostname)) 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
      - /bin/docker push 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env:$BUILDKITE_COMMIT
          debug: true
          user: root
          shell: ["/bin/bash", "-e", "-c"]
          propagate-environment: true
          always-pull: true
          mount-checkout: true
          workdir: /mounted_workdir
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
    env:
      PYTHON: "3.6"
      CI: "true"
      RAY_DEFAULT_BUILD: "1"
    agents:
      queue: simon-build-farm-q
  - wait
  - label: "Ray core"
    commands:
      - conda activate && python --version
      - bazel test --config=ci $(./scripts/bazel_export_options) --build_tests_only -- //:all -rllib/...
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
          debug: true
          user: root
          shell: ["/bin/bash", "-e", "-c", "-i"]
          shm-size: 2g
          propagate-environment: true
          mount-checkout: false
          workdir: /workdir
    agents:
      queue: simon-agent-q
  - label: "Serve"
    commands:
      - conda activate && python --version
      # - rm -rf python/ray/thirdparty_files; cd python; pip install -e . --verbose; cd ..
      - bazel test --config=ci $(./scripts/bazel_export_options) --test_tag_filters=-jenkins_only python/ray/serve/...
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
          debug: true
          user: root
          shell: ["/bin/bash", "-e", "-c", "-i"]
          shm-size: 2g
          propagate-environment: true
          mount-checkout: false
          workdir: /workdir
    agents:
      queue: simon-agent-q
  - label: "Dashboard"
    commands:
      - conda activate && python --version
      # - rm -rf python/ray/thirdparty_files; cd python; pip install -e . --verbose; cd ..
      - bazel test --config=ci $(./scripts/bazel_export_options) python/ray/new_dashboard/...
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
          debug: true
          user: root
          shell: ["/bin/bash", "-e", "-c", "-i"]
          shm-size: 2g
          propagate-environment: true
          mount-checkout: false
          workdir: /workdir
    agents:
      queue: simon-agent-q