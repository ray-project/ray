steps:
  - label: "Setting up build env"
    commands:
      - docker build -f .buildkite/Dockerfile -t 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env .
      # ECR login should be done by Elastic CI stack runners for us
      - docker push 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env
    agents:
      queue: simon-agent-q
  - wait
  - label: "Run inside build env"
    command: ./ci/travis/ci.sh init; sleep 10
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env
    agents:
      queue: simon-agent-q
