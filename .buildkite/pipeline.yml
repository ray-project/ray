steps:
  - label: "Setting up bootstrap env"
    commands:
      - mv /tmp/bazel-credential.json .
      - aws ecr get-login-password --region us-west-2 > ecr_password.txt
      - docker build -f .buildkite/Dockerfile -t 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env:$BUILDKITE_COMMIT .
      - docker push 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env:$BUILDKITE_COMMIT
    agents:
      queue: simon-agent-q
  - wait
  - label: "Build shared container"
    commands:
      - cat /root/.bazelrc
      # Copy the git checkout to local directory so it will be captured by docker commit
      - cp -r /mounted_workdir /workdir
      - cd /workdir
      # Run legacy environment setup
      - ./ci/travis/ci.sh init
      - ./ci/travis/ci.sh build
      - cat /root/.bazelrc
      # Commit this container
      - /bin/docker tag $(docker commit --pause=false $(hostname)) 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
      - /bin/docker push 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_test_env:$BUILDKITE_COMMIT
    plugins:
      - docker#v3.7.0:
          image: 029272617770.dkr.ecr.us-west-2.amazonaws.com/ray_build_env:$BUILDKITE_COMMIT
          debug: true
          user: root
          shell: ["/bin/bash", "-e", "-c"]
          propagate-environment: true
          always-pull: true
          mount-checkout: true
          workdir: /mounted_workdir
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
    env:
      PYTHON: "3.6"
      CI: "true"
      RAY_DEFAULT_BUILD: "1"
    agents:
      queue: simon-build-farm-q
  - wait
  - label: "Generate Test Suites"
    commands:
      - python .buildkite/generate_pipeline.py | buildkite-agent pipeline upload
      - python --version
      - python3 --version
    agents:
      queue: simon-agent-q
  # The rest of the steps should be generated by .buildkite/generate_pipeline.py
