group: release build
steps:
  - name: raycpubaseextra-testdeps
    label: "wanda: ray.py{{matrix}}.cpu.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cpu.wanda.yaml
    matrix:
      - "3.9"
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      IMAGE_TYPE: "ray"
      REQUIREMENTS_FILE: "ray_base_extra_testdeps_py{{matrix}}.lock"
    depends_on:
      - raycpubaseextra

  - name: raycudabaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "12.3.2-cudnn9"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray"
      REQUIREMENTS_FILE: "ray_base_extra_testdeps_py{{matrix.python}}.lock"
    depends_on:
      - raycudabaseextra

  - name: ray-llmbaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.llm.base-extra-testdeps (cuda {{matrix.cuda}})"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.11"
        cuda:
          - "12.8.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-llm"
      REQUIREMENTS_FILE: "requirements_llm_byod_{{matrix.python}}.txt"
    depends_on:
      - ray-llmbaseextra

  - name: ray-mlcudabaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.ml.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.9"
          - "3.10"
        cuda:
          - "12.1.1-cudnn8"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-ml"
      REQUIREMENTS_FILE: "requirements_ml_byod_{{matrix.python}}.txt"
    depends_on:
      - ray-mlcudabaseextra

  - label: ":tapioca: build: ray py{{matrix.python}}-{{matrix.platform}} image for release tests"
    key: anyscalebuild
    instance_type: release-medium
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- anyscale
        --python-version {{matrix.python}} --platform {{matrix.platform}}
        --image-type ray --upload
    depends_on:
      - manylinux
      - forge
      - raycpubaseextra-testdeps
      - raycudabaseextra-testdeps
    matrix:
      setup:
        python:
          # This list should be kept in sync with the list of supported Python in
          # release test suite. We don't have release tests for Python 3.10 yet.
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
        platform:
          - cu12.3.2-cudnn9
          - cpu

  - label: ":tapioca: build: ray-llm py{{matrix}} image for release tests"
    key: anyscalellmbuild
    instance_type: release-medium
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- anyscale --python-version {{matrix}}
        --platform cu12.8.1-cudnn --image-type ray-llm --upload
    depends_on:
      - manylinux
      - forge
      - ray-llmbaseextra-testdeps
    matrix:
      - "3.11"

  - label: ":tapioca: build: ray-ml py{{matrix}} image for release tests"
    key: anyscalemlbuild
    instance_type: release-medium
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- anyscale --python-version {{matrix}}
        --platform cu12.1.1-cudnn8 --image-type ray-ml --upload
    depends_on:
      - manylinux
      - forge
      - ray-mlcudabaseextra-testdeps
    matrix:
      # This list should be kept in sync with the list of supported Python in
      # release test suite. We don't have ray-ml release tests for Python 3.10 and 3.11
      # yet.
      - "3.9"
      - "3.10"
