group: release build
steps:
  - name: raycpubaseextra-testdeps
    label: "wanda: ray.py{{matrix}}.cpu.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cpu.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
      - "3.13"
    env:
      PYTHON_VERSION: "{{matrix}}"
      IMAGE_TYPE: "ray"
    depends_on:
      - raycpubaseextra

  - name: raycudabaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        cuda:
          - "12.3.2-cudnn9"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray"
    depends_on:
      - raycudabaseextra

  - name: ray-llmbaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.llm.base-extra-testdeps (cuda {{matrix.cuda}})"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.11"
        cuda:
          - "12.8.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-llm"
    depends_on:
      - ray-llmbaseextra

  - name: ray-mlcudabaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.ml.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
        cuda:
          - "12.1.1-cudnn8"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-ml"
    depends_on:
      - ray-mlcudabaseextra

  - name: ray-anyscale-cpu-build
    label: "wanda: ray-anyscale py{{matrix}} cpu"
    wanda: ci/docker/ray-anyscale-cpu.wanda.yaml
    env_file: rayci.env
    matrix:
      # This list should be kept in sync with the list of supported Python in
      # release test suite
      - "3.10"
      - "3.11"
      - "3.12"
      - "3.13"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - ray-wheel-build
      - raycpubaseextra-testdeps

  - name: ray-anyscale-cuda-build
    label: "wanda: ray-anyscale py{{matrix.python}} cu{{matrix.cuda}}"
    wanda: ci/docker/ray-anyscale-cuda.wanda.yaml
    env_file: rayci.env
    matrix:
      setup:
        python:
          # This list should be kept in sync with the list of supported Python in
          # release test suite
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        cuda:
          - "12.3.2-cudnn9"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - ray-wheel-build
      - raycudabaseextra-testdeps

  - label: ":crane: publish: ray-anyscale py{{matrix.python}} {{matrix.platform}}"
    key: anyscalebuild
    instance_type: release-medium
    mount_buildkite_agent: true
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci/automation:push_release_test_image --
        --python-version {{matrix.python}}
        --platform {{matrix.platform}}
        --image-type ray
        --upload
    depends_on:
      - ray-anyscale-cpu-build
      - ray-anyscale-cuda-build
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        platform:
          - cu12.3.2-cudnn9
          - cpu

  - name: ray-llm-anyscale-cuda-build
    label: "wanda: ray-llm-anyscale py{{matrix.python}} cu{{matrix.cuda}}"
    wanda: ci/docker/ray-llm-anyscale-cuda.wanda.yaml
    env_file: rayci.env
    matrix:
      setup:
        python:
          - "3.11"
        cuda:
          - "12.8.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - ray-wheel-build
      - ray-llmbaseextra-testdeps

  - label: ":crane: publish: ray-llm-anyscale py{{matrix.python}} {{matrix.platform}}"
    key: anyscalellmbuild
    instance_type: release-medium
    mount_buildkite_agent: true
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci/automation:push_release_test_image --
        --python-version {{matrix.python}}
        --platform {{matrix.platform}}
        --image-type ray-llm
        --upload
    depends_on:
      - ray-llm-anyscale-cuda-build
    matrix:
      setup:
        python:
          - "3.11"
        platform:
          - cu12.8.1-cudnn

  - name: ray-ml-anyscale-cuda-build
    label: "wanda: ray-ml-anyscale py{{matrix.python}} cu{{matrix.cuda}}"
    wanda: ci/docker/ray-ml-anyscale-cuda.wanda.yaml
    env_file: rayci.env
    matrix:
      setup:
        python:
          # This list should be kept in sync with the list of supported Python in
          # release test suite
          - "3.10"
        cuda:
          - "12.1.1-cudnn8"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - ray-wheel-build
      - ray-mlcudabaseextra-testdeps

  - label: ":crane: publish: ray-ml-anyscale py{{matrix}} cu12.1.1-cudnn8"
    key: anyscalemlbuild
    instance_type: release-medium
    mount_buildkite_agent: true
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci/automation:push_release_test_image --
        --python-version {{matrix}}
        --platform cu12.1.1-cudnn8
        --image-type ray-ml
        --upload
    depends_on:
      - ray-ml-anyscale-cuda-build
    matrix:
      - "3.10"
