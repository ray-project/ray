group: release build
steps:
  - name: raycpubaseextra-testdeps
    label: "wanda: ray.py{{matrix}}.cpu.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cpu.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      IMAGE_TYPE: "ray"
      REQUIREMENTS_FILE: "ray_base_extra_testdeps_py{{matrix}}.lock"
    depends_on:
      - raycpubaseextra

  - name: raycudabaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "12.3.2-cudnn9"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray"
      REQUIREMENTS_FILE: "ray_base_extra_testdeps_cuda_py{{matrix.python}}.lock"
    depends_on:
      - raycudabaseextra

  - name: ray-llmbaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.llm.base-extra-testdeps (cuda {{matrix.cuda}})"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.11"
        cuda:
          - "12.8.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-llm"
      REQUIREMENTS_FILE: "requirements_llm_byod_{{matrix.python}}.txt"
    depends_on:
      - ray-llmbaseextra

  - name: ray-mlcudabaseextra-testdeps
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.ml.base-extra-testdeps"
    wanda: docker/base-extra-testdeps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
        cuda:
          - "12.1.1-cudnn8"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-ml"
      REQUIREMENTS_FILE: "ray_ml_base_extra_testdeps_cuda_py{{matrix.python}}.lock"
    depends_on:
      - ray-mlcudabaseextra

  # Build ray anyscale images using wanda (CPU)
  - name: ray-anyscale-cpu-build
    label: "wanda: ray-anyscale py{{matrix}} cpu"
    key: anyscale_cpu
    wanda: ci/docker/ray-anyscale-cpu.wanda.yaml
    matrix:
      # This list should be kept in sync with the list of supported Python in
      # release test suite
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - linux_wheels
      - raycpubaseextra-testdeps

  # Build ray anyscale images using wanda (CUDA)
  - name: ray-anyscale-cuda-build
    label: "wanda: ray-anyscale py{{matrix.python}} cu{{matrix.cuda}}"
    key: anyscale_cuda
    wanda: ci/docker/ray-anyscale-cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "12.3.2-cudnn9"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - linux_wheels
      - raycudabaseextra-testdeps

  # Push anyscale images to ECR/GCP/Azure registries
  # Combines CPU and CUDA results for backward compatibility with anyscalebuild key
  - label: ":docker: push: ray-anyscale py{{matrix.python}} {{matrix.platform}}"
    key: anyscalebuild
    instance_type: release-medium
    mount_buildkite_agent: true
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci/automation:push_anyscale_image --
        --python-version {{matrix.python}}
        --platform {{matrix.platform}}
        --image-type ray
        --upload
    depends_on:
      - anyscale_cpu
      - anyscale_cuda
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        platform:
          - cu12.3.2-cudnn9
          - cpu

  # Build ray-llm anyscale image using wanda
  - name: ray-llm-anyscale-cuda-build
    label: "wanda: ray-llm-anyscale py{{matrix.python}} cu{{matrix.cuda}}"
    key: anyscale_llm_cuda
    wanda: ci/docker/ray-llm-anyscale-cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.11"
        cuda:
          - "12.8.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - linux_wheels
      - ray-llmbaseextra-testdeps

  # Push ray-llm anyscale images to ECR/GCP/Azure registries
  - label: ":docker: push: ray-llm-anyscale py{{matrix}} cu12.8.1-cudnn"
    key: anyscalellmbuild
    instance_type: release-medium
    mount_buildkite_agent: true
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci/automation:push_anyscale_image --
        --python-version {{matrix}}
        --platform cu12.8.1-cudnn
        --image-type ray-llm
        --upload
    depends_on:
      - anyscale_llm_cuda
    matrix:
      - "3.11"

  # Build ray-ml anyscale image using wanda
  - name: ray-ml-anyscale-cuda-build
    label: "wanda: ray-ml-anyscale py{{matrix.python}} cu{{matrix.cuda}}"
    key: anyscale_ml_cuda
    wanda: ci/docker/ray-ml-anyscale-cuda.wanda.yaml
    matrix:
      setup:
        python:
          # This list should be kept in sync with the list of supported Python in
          # release test suite
          - "3.10"
        cuda:
          - "12.1.1-cudnn8"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: ""
    tags:
      - oss
    depends_on:
      - linux_wheels
      - ray-mlcudabaseextra-testdeps

  # Push ray-ml anyscale images to ECR/GCP/Azure registries
  - label: ":docker: push: ray-ml-anyscale py{{matrix}} cu12.1.1-cudnn8"
    key: anyscalemlbuild
    instance_type: release-medium
    mount_buildkite_agent: true
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci/automation:push_anyscale_image --
        --python-version {{matrix}}
        --platform cu12.1.1-cudnn8
        --image-type ray-ml
        --upload
    depends_on:
      - anyscale_ml_cuda
    matrix:
      # This list should be kept in sync with the list of supported Python in
      # release test suite
      - "3.10"
