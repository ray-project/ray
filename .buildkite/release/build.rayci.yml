group: release build
steps:
  - name: raycpubaseextra-test
    label: "wanda: ray.py{{matrix}}.cpu.base-extra-test"
    wanda: ci/docker/ray.cpu.base-extra-test.wanda.yaml
    matrix:
      - "3.9"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      IMAGE_TYPE: "ray"
      REQUIREMENTS_FILE: "requirements_byod_{{matrix}}.txt"
    depends_on:
      - raycpubaseextra
  
  - name: raycudabaseextra-test
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.base-extra-test"
    wanda: ci/docker/ray.cuda.base-extra-test.wanda.yaml
    matrix:
      setup:
        python:
          - "3.9"
          - "3.11"
          - "3.12"
        cuda:
          - "12.3.2-cudnn9"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray"
      REQUIREMENTS_FILE: "requirements_byod_{{matrix.python}}.txt"
    depends_on:
      - raycudabaseextra
  
  - name: ray-llmbaseextra-test
    label: "wanda: ray.py{{matrix}}.llm.base-extra-test"
    wanda: ci/docker/ray.cuda.base-extra-test.wanda.yaml
    matrix:
      setup:
        python:
          - "3.9"
        cuda:
          - "12.8.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-llm"
      REQUIREMENTS_FILE: "requirements_llm_byod_{{matrix.python}}.txt"
    depends_on:
      - ray-llmbaseextra

  - name: ray-mlcudabaseextra-test
    label: "wanda: ray.py{{matrix}}.ml.base-extra-test"
    wanda: ci/docker/ray.cuda.base-extra-test.wanda.yaml
    matrix:
      setup:
        python:
          - "3.9"
        cuda:
          - "12.1.1-cudnn8"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray-ml"
      REQUIREMENTS_FILE: "requirements_ml_byod_{{matrix.python}}.txt"
    depends_on:
      - ray-mlcudabaseextra

  - label: ":tapioca: build: anyscale py{{matrix.python}}-{{matrix.platform}} docker"
    key: anyscalebuild
    instance_type: release-medium
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- anyscale
        --python-version {{matrix.python}} --platform {{matrix.platform}}
        --image-type ray --upload
    depends_on:
      - manylinux
      - forge
      - raycpubaseextra-test
      - raycudabaseextra-test
    matrix:
      setup:
        python:
          # This list should be kept in sync with the list of supported Python in
          # release test suite. We don't have release tests for Python 3.10 yet.
          - "3.9"
          - "3.11"
          - "3.12"
        platform:
          - cu12.3.2-cudnn9
          - cpu

  - label: ":tapioca: build: anyscale-llm py{{matrix}} docker"
    key: anyscalellmbuild
    instance_type: release-medium
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- anyscale --python-version {{matrix}}
        --platform cu12.8.1-cudnn --image-type ray-llm --upload
    depends_on:
      - manylinux
      - forge
      - ray-llmbaseextra-test
    matrix:
      - "3.11"

  - label: ":tapioca: build: anyscale-ml py{{matrix}} docker"
    key: anyscalemlbuild
    instance_type: release-medium
    tags:
      - oss
    commands:
      - bazel run //ci/ray_ci:build_in_docker -- anyscale --python-version {{matrix}}
        --platform cu12.1.1-cudnn8 --image-type ray-ml --upload
    depends_on:
      - manylinux
      - forge
      - ray-mlcudabaseextra-test
    matrix:
      # This list should be kept in sync with the list of supported Python in
      # release test suite. We don't have ray-ml release tests for Python 3.10 and 3.11
      # yet.
      - "3.9"
