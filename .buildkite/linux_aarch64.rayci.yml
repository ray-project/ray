group: aarch64 tests
sort_key: "~aarch64"
steps:
  # block on premerge and microcheck
  - block: "Run Linux aarch64 tests"
    if: build.env("BUILDKITE_PIPELINE_ID") == "0189942e-0876-4b8f-80a4-617f988ec59b" || build.env("BUILDKITE_PIPELINE_ID") == "018f4f1e-1b73-4906-9802-92422e3badaa"

  - name: forge-aarch64
    wanda: ci/docker/forge.aarch64.wanda.yaml
    instance_type: builder-arm64

  - name: manylinux-aarch64
    wanda: ci/docker/manylinux.wanda.yaml
    env:
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    instance_type: builder-arm64

  - name: ray-java-build-aarch64
    label: "wanda: java build (aarch64)"
    wanda: ci/docker/ray-java.wanda.yaml
    tags:
      - release_wheels
      - java
      - oss
    env:
      ARCH_SUFFIX: "-aarch64"
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    instance_type: builder-arm64

  - name: ray-dashboard-build-aarch64
    label: "wanda: dashboard (aarch64)"
    wanda: ci/docker/ray-dashboard.wanda.yaml
    env:
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    tags: release_wheels
    instance_type: builder-arm64

  - name: raycpubase-aarch64
    label: "wanda: ray.py{{matrix}}.cpu.base (aarch64)"
    tags:
      - python_dependencies
      - docker
    wanda: docker/base-deps/cpu.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    instance_type: builder-arm64
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
      REQUIREMENTS_FILE: "ray_base_deps_py{{matrix}}.lock"

  - name: raycpubaseextra-aarch64
    label: "wanda: ray.py{{matrix}}.cpu.base-extra (aarch64)"
    wanda: docker/base-extra/cpu.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    instance_type: builder-arm64
    env:
      PYTHON_VERSION: "{{matrix}}"
      IMAGE_TYPE: "ray"
      ARCH_SUFFIX: "-aarch64"
      REQUIREMENTS_FILE: "ray_base_extra_py{{matrix}}.lock"
    depends_on: raycpubase-aarch64

  - name: raycudabase-aarch64
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.base (aarch64)"
    tags:
      - python_dependencies
      - docker
    wanda: docker/base-deps/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "11.7.1-cudnn8"
          - "11.8.0-cudnn8"
          - "12.1.1-cudnn8"
          - "12.3.2-cudnn9"
          - "12.4.1-cudnn"
          - "12.5.1-cudnn"
          - "12.6.3-cudnn"
          - "12.8.1-cudnn"
          - "12.9.1-cudnn"
    instance_type: builder-arm64
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: "-aarch64"
      REQUIREMENTS_FILE: "ray_base_deps_py{{matrix.python}}.lock"

  - name: raycudabaseextra-aarch64
    label: "wanda: ray.py{{matrix.python}}.cu{{matrix.cuda}}.base-extra (aarch64)"
    wanda: docker/base-extra/cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "11.7.1-cudnn8"
          - "11.8.0-cudnn8"
          - "12.1.1-cudnn8"
          - "12.3.2-cudnn9"
          - "12.4.1-cudnn"
          - "12.5.1-cudnn"
          - "12.6.3-cudnn"
          - "12.8.1-cudnn"
          - "12.9.1-cudnn"
    instance_type: builder-arm64
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      IMAGE_TYPE: "ray"
      ARCH_SUFFIX: "-aarch64"
      REQUIREMENTS_FILE: "ray_base_extra_py{{matrix.python}}.lock"
    depends_on: raycudabase-aarch64

  - name: ray-core-build-aarch64
    label: "wanda: core binary parts py{{matrix}} (aarch64)"
    wanda: ci/docker/ray-core.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
      - "3.13"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    tags: release_wheels
    instance_type: builder-arm64

  - name: ray-wheel-build-aarch64
    label: "wanda: wheel py{{matrix}} (aarch64)"
    wanda: ci/docker/ray-wheel.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
      - "3.13"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    tags:
      - release_wheels
      - linux_wheels
      - oss
    instance_type: builder-arm64
    depends_on:
      - ray-core-build-aarch64
      - ray-java-build-aarch64
      - ray-dashboard-build-aarch64

  # Build ray-cpp core (C++ headers, libs, examples) for aarch64
  - name: ray-cpp-core-build-aarch64
    label: "wanda: cpp core py{{matrix}} (aarch64)"
    wanda: ci/docker/ray-cpp-core.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    tags:
      - release_wheels
      - oss
    instance_type: builder-arm64

  # Build ray-cpp wheel for aarch64
  - name: ray-cpp-wheel-build-aarch64
    label: "wanda: cpp wheel py{{matrix}} (aarch64)"
    wanda: ci/docker/ray-cpp-wheel.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
      HOSTTYPE: "aarch64"
      MANYLINUX_VERSION: "260103.868e54c"
    tags:
      - release_wheels
      - linux_wheels
      - oss
    instance_type: builder-arm64
    depends_on:
      - ray-core-build-aarch64
      - ray-cpp-core-build-aarch64
      - ray-java-build-aarch64
      - ray-dashboard-build-aarch64

  # Upload wheels to S3 (aarch64)
  # Gating: only on releases/* OR (master AND nightly)
  - label: ":s3: upload: wheel py{{matrix}} (aarch64)"
    key: linux_wheels_upload_aarch64
    if: build.branch =~ /^releases\// || (build.branch == "master" && build.env("RAYCI_SCHEDULE") == "nightly")
    instance_type: small-arm64
    commands:
      # Extract wheel from wanda image (Wanda cache in ECR)
      - wanda_image="$RAYCI_WORK_REPO:$RAYCI_BUILD_ID-ray-wheel-py{{matrix}}-aarch64"
      - container_id=$(docker create $wanda_image)
      - mkdir -p /tmp/wheels
      - docker cp ${container_id}:/ /tmp/wheels/
      - docker rm ${container_id}
      - mv /tmp/wheels/*.whl .whl/
      - ./ci/build/copy_build_artifacts.sh wheel
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
      - "3.13"
    depends_on:
      - ray-wheel-build-aarch64
    tags:
      - release_wheels
      - skip-on-premerge

  # Upload cpp wheels to S3 (aarch64)
  # Gating: only on releases/* OR (master AND nightly)
  - label: ":s3: upload: cpp wheel py{{matrix}} (aarch64)"
    key: linux_cpp_wheels_upload_aarch64
    if: build.branch =~ /^releases\// || (build.branch == "master" && build.env("RAYCI_SCHEDULE") == "nightly")
    instance_type: small-arm64
    commands:
      # Extract cpp wheel from wanda image (Wanda cache in ECR)
      - wanda_image="$RAYCI_WORK_REPO:$RAYCI_BUILD_ID-ray-cpp-wheel-py{{matrix}}-aarch64"
      - container_id=$(docker create $wanda_image)
      - mkdir -p /tmp/wheels
      - docker cp ${container_id}:/ /tmp/wheels/
      - docker rm ${container_id}
      - mv /tmp/wheels/*.whl .whl/
      - ./ci/build/copy_build_artifacts.sh wheel
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    depends_on:
      - ray-cpp-wheel-build-aarch64
    tags:
      - release_wheels
      - skip-on-premerge

  - name: ray-extra-image-cpu-build-aarch64
    label: "wanda: ray-extra py{{matrix}} cpu (aarch64)"
    wanda: ci/docker/ray-extra-image-cpu.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
    tags:
      - python_dependencies
      - docker
      - oss
    instance_type: builder-arm64
    depends_on:
      - ray-wheel-build-aarch64
      - raycpubaseextra-aarch64

  - name: ray-extra-image-cuda-build-aarch64
    label: "wanda: ray-extra py{{matrix.python}} cu{{matrix.cuda}} (aarch64)"
    wanda: ci/docker/ray-extra-image-cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "11.7.1-cudnn8"
          - "11.8.0-cudnn8"
          - "12.1.1-cudnn8"
          - "12.3.2-cudnn9"
          - "12.4.1-cudnn"
          - "12.5.1-cudnn"
          - "12.6.3-cudnn"
          - "12.8.1-cudnn"
          - "12.9.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: "-aarch64"
    tags:
      - python_dependencies
      - docker
      - oss
    instance_type: builder-arm64
    depends_on:
      - ray-wheel-build-aarch64
      - raycudabaseextra-aarch64

  - name: ray-image-cpu-build-aarch64
    label: "wanda: ray py{{matrix}} cpu (aarch64)"
    wanda: ci/docker/ray-image-cpu.wanda.yaml
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    env:
      PYTHON_VERSION: "{{matrix}}"
      ARCH_SUFFIX: "-aarch64"
    tags:
      - python_dependencies
      - docker
      - oss
    instance_type: builder-arm64
    depends_on:
      - ray-wheel-build-aarch64
      - raycpubase-aarch64

  - name: ray-image-cuda-build-aarch64
    label: "wanda: ray py{{matrix.python}} cu{{matrix.cuda}} (aarch64)"
    wanda: ci/docker/ray-image-cuda.wanda.yaml
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "11.7.1-cudnn8"
          - "11.8.0-cudnn8"
          - "12.1.1-cudnn8"
          - "12.3.2-cudnn9"
          - "12.4.1-cudnn"
          - "12.5.1-cudnn"
          - "12.6.3-cudnn"
          - "12.8.1-cudnn"
          - "12.9.1-cudnn"
    env:
      PYTHON_VERSION: "{{matrix.python}}"
      CUDA_VERSION: "{{matrix.cuda}}"
      ARCH_SUFFIX: "-aarch64"
    tags:
      - python_dependencies
      - docker
      - oss
    instance_type: builder-arm64
    depends_on:
      - ray-wheel-build-aarch64
      - raycudabase-aarch64

  # Push ray CPU images to Docker Hub (aarch64)
  # Gating: only on releases/* OR (master AND nightly)
  - label: ":docker: push: ray py{{matrix}} cpu (aarch64)"
    key: ray_images_aarch64
    if: build.branch =~ /^releases\// || (build.branch == "master" && build.env("RAYCI_SCHEDULE") == "nightly")
    instance_type: small-arm64
    commands:
      - bazel run //.buildkite:copy_files -- --destination docker_login
      - bazel run //ci/ray_ci/automation:push_ray_image --
        --python-version {{matrix}}
        --platform cpu
        --architecture aarch64
        --upload
    matrix:
      - "3.10"
      - "3.11"
      - "3.12"
    depends_on:
      - ray-image-cpu-build-aarch64
    tags:
      - python_dependencies
      - docker
      - skip-on-premerge

  # Push ray CUDA images to Docker Hub (aarch64)
  # Gating: only on releases/* OR (master AND nightly)
  - label: ":docker: push: ray py{{matrix.python}} cu{{matrix.cuda}} (aarch64)"
    key: ray_images_cuda_aarch64
    if: build.branch =~ /^releases\// || (build.branch == "master" && build.env("RAYCI_SCHEDULE") == "nightly")
    instance_type: small-arm64
    commands:
      - bazel run //.buildkite:copy_files -- --destination docker_login
      - bazel run //ci/ray_ci/automation:push_ray_image --
        --python-version {{matrix.python}}
        --platform cu{{matrix.cuda}}
        --architecture aarch64
        --upload
    matrix:
      setup:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
        cuda:
          - "11.7.1-cudnn8"
          - "11.8.0-cudnn8"
          - "12.1.1-cudnn8"
          - "12.3.2-cudnn9"
          - "12.4.1-cudnn"
          - "12.5.1-cudnn"
          - "12.6.3-cudnn"
          - "12.8.1-cudnn"
          - "12.9.1-cudnn"
    depends_on:
      - ray-image-cuda-build-aarch64
    tags:
      - python_dependencies
      - docker
      - skip-on-premerge

  - label: ":ray: core: wheel-aarch64 tests"
    tags: linux_wheels
    instance_type: medium-arm64
    commands:
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/tests/... //doc/... core
        --build-type wheel-aarch64
        --build-name oss-ci-base_build-aarch64
        --parallelism-per-worker 3
        --only-tags post_wheel_build
        --test-env=RAY_CI_POST_WHEEL_TESTS=True
        --python-version 3.10
    depends_on:
      - manylinux-aarch64
      - oss-ci-base_build-aarch64
      - forge-aarch64
    job_env: forge-aarch64

  - label: ":ray-serve: serve: wheel-aarch64 tests"
    tags: linux_wheels
    instance_type: medium-arm64
    commands:
      - bazel run //ci/ray_ci:test_in_docker -- //python/ray/serve/... //doc/... serve
        --build-type wheel-aarch64
        --build-name oss-ci-base_build-aarch64
        --parallelism-per-worker 3
        --only-tags post_wheel_build
        --test-env=RAY_CI_POST_WHEEL_TESTS=True
        --python-version 3.10
    depends_on:
      - manylinux-aarch64
      - oss-ci-base_build-aarch64
      - forge-aarch64
    job_env: forge-aarch64
